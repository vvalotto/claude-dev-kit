name: Sync Documentation to Wiki

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
  workflow_dispatch:

jobs:
  sync-wiki:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Clone Wiki repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git clone https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git wiki

      - name: Sync Documentation with Flattened Structure
        run: |
          # FunciÃ³n para convertir kebab-case a PascalCase
          to_pascal_case() {
            echo "$1" | sed -E 's/(^|-)([a-z])/\U\2/g'
          }

          # Casos especiales
          cp docs/README.md wiki/Home.md
          cp docs/user/index.md wiki/Documentation-Index.md

          # Sincronizar user/ - archivos directos
          for file in docs/user/*.md; do
            [ -f "$file" ] || continue
            [ "$(basename "$file")" = "index.md" ] && continue

            filename=$(basename "$file" .md)
            pascal_name=$(to_pascal_case "$filename")
            cp "$file" "wiki/user-${pascal_name}.md"
          done

          # Sincronizar user/skills/
          for file in docs/user/skills/*.md; do
            [ -f "$file" ] || continue

            filename=$(basename "$file" .md)
            pascal_name=$(to_pascal_case "$filename")
            cp "$file" "wiki/user-skills-${pascal_name}.md"
          done

          # Sincronizar user/tracking/
          for file in docs/user/tracking/*.md; do
            [ -f "$file" ] || continue

            filename=$(basename "$file" .md)
            pascal_name=$(to_pascal_case "$filename")
            cp "$file" "wiki/user-tracking-${pascal_name}.md"
          done

          # Sincronizar developer/architecture/
          for file in docs/developer/architecture/*.md; do
            [ -f "$file" ] || continue

            filename=$(basename "$file" .md)
            pascal_name=$(to_pascal_case "$filename")
            cp "$file" "wiki/developer-architecture-${pascal_name}.md"
          done

          # Sincronizar developer/contributing/
          for file in docs/developer/contributing/*.md; do
            [ -f "$file" ] || continue

            filename=$(basename "$file" .md)
            pascal_name=$(to_pascal_case "$filename")
            cp "$file" "wiki/developer-contributing-${pascal_name}.md"
          done

          echo "âœ… DocumentaciÃ³n sincronizada con estructura aplanada"
          echo "ðŸ“ Archivos en wiki/:"
          ls -la wiki/*.md | wc -l
          echo "archivos .md copiados"

      - name: Commit and Push to Wiki
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd wiki
          git add .

          # Verificar si hay cambios
          if git diff --staged --quiet; then
            echo "No changes to sync"
            exit 0
          fi

          # Commit y push
          git commit -m "docs: sync documentation from main repo

          Synced from commit: ${{ github.sha }}
          Triggered by: ${{ github.event_name }}

          Structure: Flattened (all files in root with hyphenated names)
          - docs/user/getting-started.md â†’ user-Getting-Started.md
          - docs/user/skills/implement-us.md â†’ user-skills-Implement-Us.md
          - docs/developer/architecture/tracking.md â†’ developer-architecture-Tracking.md

          Files synced: $(ls *.md 2>/dev/null | wc -l) pages
          "

          git push https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git master

      - name: Summary
        if: success()
        run: |
          echo "âœ… Documentation successfully synced to Wiki"
          echo "ðŸ“š Wiki URL: https://github.com/${{ github.repository }}/wiki"
